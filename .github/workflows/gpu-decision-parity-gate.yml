name: GPU Decision Parity Gate

on:
  pull_request:
    paths:
      - 'backtester/crates/bt-signals/src/**'
      - 'backtester/crates/bt-core/src/**'
      - 'backtester/crates/bt-gpu/codegen/**'
      - 'backtester/crates/bt-gpu/kernels/**'
      - 'backtester/crates/bt-gpu/src/**'
      - 'backtester/crates/risk-core/src/**'

permissions:
  contents: read

jobs:
  parity-gate:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
      - uses: Swatinem/rust-cache@v2
        with:
          workspaces: backtester
      - name: Run decision parity tests
        working-directory: backtester
        run: cargo test -p bt-gpu --features codegen --test gpu_decision_parity --test gpu_sweep_full_parity
      - name: Run unit tests
        working-directory: backtester
        run: cargo test -p bt-gpu --features codegen --lib
