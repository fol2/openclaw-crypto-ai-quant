name: Three-Way Parity

on:
  push:
    branches: [master, major-v8]
    paths:
      - 'backtester/**'
  pull_request:
    branches: [master, major-v8]
    paths:
      - 'backtester/**'
  workflow_dispatch:
    inputs:
      tol_pnl:
        description: 'PnL tolerance (default 0.02)'
        required: false
        default: '0.02'
      tol_dd:
        description: 'Max drawdown tolerance (default 0.03)'
        required: false
        default: '0.03'
      tol_wr:
        description: 'Win rate tolerance (default 0.05)'
        required: false
        default: '0.05'
      tol_tc:
        description: 'Trade count tolerance (default 0.05)'
        required: false
        default: '0.05'
      tol_pf:
        description: 'Profit factor tolerance (default 0.50)'
        required: false
        default: '0.50'

permissions:
  contents: read

jobs:
  three-way-parity:
    name: three-way-parity
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Check fixtures exist
        id: fixtures
        run: |
          FIXTURE_DIR="backtester/testdata/three_way_parity"
          if [ -f "$FIXTURE_DIR/gpu_sweep.jsonl" ] && \
             [ -f "$FIXTURE_DIR/cpu_replay.json" ] && \
             [ -f "$FIXTURE_DIR/kernel_shadow_report.json" ]; then
            echo "available=true" >> "$GITHUB_OUTPUT"
          else
            echo "available=false" >> "$GITHUB_OUTPUT"
            echo "::notice::Three-way parity fixtures not found; skipping."
          fi

      - name: Run three-way parity
        if: steps.fixtures.outputs.available == 'true'
        env:
          AQC_3WAY_TOL_PNL: ${{ inputs.tol_pnl || '0.02' }}
          AQC_3WAY_TOL_DD: ${{ inputs.tol_dd || '0.03' }}
          AQC_3WAY_TOL_WR: ${{ inputs.tol_wr || '0.05' }}
          AQC_3WAY_TOL_TC: ${{ inputs.tol_tc || '0.05' }}
          AQC_3WAY_TOL_PF: ${{ inputs.tol_pf || '0.50' }}
        run: |
          python backtester/scripts/three_way_parity.py \
            --gpu-results backtester/testdata/three_way_parity/gpu_sweep.jsonl \
            --cpu-results backtester/testdata/three_way_parity/cpu_replay.json \
            --shadow-report backtester/testdata/three_way_parity/kernel_shadow_report.json \
            --output artifacts/parity/ \
            --ci

      - name: Upload parity report
        if: steps.fixtures.outputs.available == 'true' && always()
        uses: actions/upload-artifact@v6
        with:
          name: parity-report
          path: artifacts/parity/
          retention-days: 30
