name: V8 Engine Unification Gates

on:
  pull_request:
    branches: [master, major-v8]
  push:
    branches: [master, major-v8]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  unification-gates:
    name: v8-unification-gates
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect engine unification changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            unification:
              - 'engine/core.py'
              - 'factory_run.py'
              - 'tools/replay_equivalence.py'
              - 'schemas/gpu_candidate_schema.json'
              - 'tests/test_gpu_candidate_schema.py'
              - 'tests/test_replay_equivalence.py'
              - 'tests/test_factory_replay_harness.py'
              - 'tests/test_kernel_decision_routing.py'
              - 'tests/test_factory_sweep_candidate_schema.py'
              - 'tests/test_factory_run_stage_metadata.py'
              - 'tests/test_validate_factory_selection_gate.py'
              - 'docs/v8/gpu_acceleration_boundary.md'
              - 'docs/runbook.md'
              - '.github/workflows/v8-unification-pr-gates.yml'

      - name: Set up Python
        if: steps.changes.outputs.unification == 'true'
        uses: actions/setup-python@v6
        with:
          python-version: '3.12'

      - name: Install uv
        if: steps.changes.outputs.unification == 'true'
        run: |
          python -m pip install --upgrade pip
          python -m pip install --quiet uv

      - name: Install Python dependencies
        if: steps.changes.outputs.unification == 'true'
        run: uv sync --frozen --dev

      - name: Run unification unit tests
        if: steps.changes.outputs.unification == 'true'
        run: |
          PYTEST_ADDOPTS='--no-cov' uv run pytest tests/test_kernel_decision_routing.py \
            tests/test_replay_equivalence.py \
            tests/test_factory_replay_harness.py \
            tests/test_factory_sweep_candidate_schema.py \
            tests/test_gpu_candidate_schema.py \
            tests/test_factory_run_stage_metadata.py \
            tests/test_validate_factory_selection_gate.py

      - name: Skip when unification files are unchanged
        if: steps.changes.outputs.unification != 'true'
        run: echo "Unification files unchanged; skipping unification gates."
