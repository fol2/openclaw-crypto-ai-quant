name: GPU Parity Gate

on:
  pull_request:
    branches: [master, major-v8]
  push:
    branches: [master, major-v8]
  workflow_dispatch:

permissions:
  contents: read

jobs:
  gpu-parity-gate:
    name: gpu-parity-gate (warning unless strict)
    runs-on: ${{ vars.AQC_GPU_PARITY_RUNNER || 'ubuntu-latest' }}
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect GPU runtime changes
        id: changes
        uses: dorny/paths-filter@v3
        with:
          filters: |
            gpu_runtime:
              - 'backtester/crates/bt-gpu/**'
              - 'backtester/crates/bt-core/**'
              - 'backtester/testdata/gpu_cpu_parity/**'
              - 'backtester/Cargo.toml'
              - 'backtester/Cargo.lock'
              - 'scripts/ci_gpu_parity_gate.sh'
              - '.github/workflows/gpu-parity-gate.yml'

      - name: Set up Rust
        if: steps.changes.outputs.gpu_runtime == 'true'
        uses: dtolnay/rust-toolchain@stable

      - name: Run GPU parity gate
        if: steps.changes.outputs.gpu_runtime == 'true'
        env:
          AQC_GPU_PARITY_STRICT: ${{ vars.AQC_GPU_PARITY_STRICT || '0' }}
        run: ./scripts/ci_gpu_parity_gate.sh

      - name: Skip when GPU runtime is unchanged
        if: steps.changes.outputs.gpu_runtime != 'true'
        run: echo "GPU runtime files unchanged; parity gate not required."
