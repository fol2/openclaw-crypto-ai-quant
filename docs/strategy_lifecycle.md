# Strategy Lifecycle State Machine

Defines the states a trading config passes through from generation to retirement, the transitions between them, and the measurable triggers that cause each transition.

## States

| State | Description |
|-------|-------------|
| `candidate` | Generated by nightly GPU sweep; not yet validated |
| `validated` | Passed OOS validation suite; eligible for paper deployment |
| `paper` | Running in paper trading; collecting fill/slippage/latency data |
| `live_small` | Live with ramped sizing (25% → 50% → 100% of target) |
| `live_full` | Live at 100% target size; steady state |
| `paused` | Pulled from trading due to a trigger; awaiting re-validation or retirement |
| `retired` | Permanently archived; no longer eligible for deployment |

## State Diagram

```
                ┌───────────┐
                │ candidate │
                └─────┬─────┘
                      │
          ┌───────────┴───────────┐
          │ OOS validation suite  │
          ▼                       ▼
    ┌───────────┐           ┌─────────┐
    │ validated │           │ retired │
    └─────┬─────┘           └─────────┘
          │                       ▲
          │ auto-deploy           │
          ▼                       │
    ┌─────────┐                   │
    │  paper  ├───────────────────┤
    └────┬────┘  gate fail /      │
         │       kill-switch      │
         │                        │
         │ gate pass              │
         ▼                        │
    ┌────────────┐                │
    │ live_small ├────────┐       │
    └─────┬──────┘        │       │
          │               │       │
          │ ramp done     │       │
          ▼               │       │
    ┌───────────┐         │       │
    │ live_full ├──┐      │       │
    └───────────┘  │      │       │
                   │      │       │
                   ▼      ▼       │
              ┌──────────┐        │
              │  paused  ├────────┘
              └────┬─────┘
                   │ re-validated
                   ▼
             ┌───────────┐
             │ validated │  (re-enters normal flow)
             └───────────┘
```

## Transitions

Every trigger below is measurable from logs, metrics, or the nightly validation pipeline. No subjective judgement is involved.

### candidate → validated

**Trigger**: Config passes the nightly OOS validation suite.

All conditions must be met:

| Check | Metric | Threshold |
|-------|--------|-----------|
| Walk-forward OOS | Median OOS daily return across all splits | > 0 |
| Slippage stress | Net PnL at 20 bps slippage | > 0 |
| Minimum trades | Total trades in evaluation window | ≥ 30 |
| Concentration | PnL share from top-1 symbol | < 50% |

**Source**: nightly validation pipeline output (JSONL).

### candidate → retired

**Trigger**: Config fails any condition in the validation suite above.

**Logged fields**: config hash, failure reason(s), validation timestamp.

### validated → paper

**Trigger**: Automatic deployment to paper trading as part of the nightly pipeline.

The top 1–3 validated candidates are deployed each cycle.

### paper → live_small

**Trigger**: Paper gate pass (Gate 1 + Gate 2 from `success_metrics.md`).

All conditions must be met:

| Gate | Metric | Threshold |
|------|--------|-----------|
| Minimum run | Duration or trade count | ≥ 1 full trading day OR ≥ 20 trades |
| Profit factor | Paper PF | ≥ 1.2 |
| Drawdown | Paper max DD | < 10% |
| Slippage stress | Net PnL at 20 bps | > 0 |
| Kill-switch | Kill-switch fires during paper | 0 |

**Source**: paper trading DB + logs.

### paper → paused

**Trigger**: Any of:
- Paper gate fail (any condition above not met after minimum run completes)
- Kill-switch fires during paper run

### live_small → live_full

**Trigger**: Ramp completion (Gate 3 from `success_metrics.md`).

`live_small` progresses through three internal ramp stages:

| Ramp stage | Size | Minimum duration | Advance condition |
|------------|------|-----------------|-------------------|
| 1 | 25% of target | 1 day | Zero kill-switch triggers |
| 2 | 50% of target | 1 day | Zero kill-switch triggers |
| 3 (= `live_full`) | 100% of target | — | Steady state |

The current ramp stage is tracked as a metadata attribute on the config, not as a separate state.

### live_small → paused

**Trigger**: Any of:
- Kill-switch fires during ramp
- Any rotation trigger (see `live_full → paused` below)

Step down or pause immediately.

### live_full → paused

**Trigger**: Any rotation criterion from `success_metrics.md`:

| Trigger | Metric | Threshold |
|---------|--------|-----------|
| Rolling PF degradation | PF over last 30 trades | < 1.0 |
| Drawdown warning | DD from config-start HWM | > 15% |
| Nightly validation fail | OOS validation suite result | Fail |
| Max config age | Days since deployment | > 14 |

**Source**: live trading DB (rolling window) + nightly validation pipeline.

### paused → validated

**Trigger**: Config re-passes the OOS validation suite (same criteria as `candidate → validated`).

This is the only path back to active trading. A paused config cannot skip directly to `paper`.

### paused → retired

**Trigger**: Any of:
- Config fails re-validation
- A replacement config has been promoted (the paused config is no longer needed)
- Manual operator decision (logged with reason)

## Metadata Recorded at Each Transition

Every state transition writes a record with:

| Field | Description |
|-------|-------------|
| `config_hash` | SHA-256 of the YAML config |
| `from_state` | Previous state |
| `to_state` | New state |
| `trigger` | Which trigger caused the transition |
| `timestamp` | UTC ISO-8601 |
| `metrics_snapshot` | Key metrics at transition time (PnL, PF, DD, trade count, Sharpe) |
| `ramp_stage` | Current ramp stage (only relevant for `live_small`) |
| `reason` | Human-readable or pipeline-generated explanation |

## Terminal States

- **`retired`** is the only terminal state. Once retired, a config is never re-deployed.
- **`live_full`** is the only steady-state. All other states are transient.

## References

- [Success Metrics & Guardrails](success_metrics.md) — thresholds referenced by transitions
- [Operations Runbook](runbook.md) — emergency stop, rollback, and diagnostics
- [Architecture](ARCHITECTURE.md) — factory pipeline and system design
