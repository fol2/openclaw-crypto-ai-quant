# Live vs Backtester Action Reconciliation

## Objective

Validate action-level parity across `live` baseline and replayed `backtester` output for the same bundle window.

Compared canonical actions:

- `OPEN_LONG`, `OPEN_SHORT`
- `ADD_LONG`, `ADD_SHORT`
- `REDUCE_LONG`, `REDUCE_SHORT`
- `CLOSE_LONG`, `CLOSE_SHORT`
- `FUNDING` (classified as accepted residual when one side is missing)
- replay-only actions with reason code `exit_end_of_backtest` (classified as accepted residual)

## Inputs

- `live_baseline_trades.jsonl` from replay bundle
- `backtester_replay_report.json` generated by `mei-backtester replay --trades --output ...`
- `live_order_fail_events.jsonl` (optional but recommended), exported from live `audit_events` rows whose event starts with `LIVE_ORDER_FAIL_`

## Command

```bash
python tools/audit_live_backtester_action_reconcile.py \
  --live-baseline /tmp/live_replay_bundle_1h/live_baseline_trades.jsonl \
  --backtester-replay-report /tmp/live_replay_bundle_1h/backtester_replay_report.json \
  --live-order-fail-events /tmp/live_replay_bundle_1h/live_order_fail_events.jsonl \
  --timestamp-bucket-ms 1 \
  --output /tmp/live_replay_bundle_1h/action_reconcile_report.json
```

Use `--timestamp-bucket-ms > 1` only when your live timestamp serialisation is intentionally coarser.

## What Is Checked

- Key match: `symbol + action_code + timestamp_ms`
- Numeric fields: `price`, `size`, `pnl_usd`, `fee_usd`, `balance`
- Confidence parity when both sides provide a confidence value
- Canonical reason-code parity (live reason text is classified with the same taxonomy used by backtester)

## Taxonomy

- `deterministic_logic_divergence`
  - missing action on either side
  - confidence mismatch
  - reason-code mismatch
- `numeric_policy_divergence`
  - matched key exists but numeric deltas exceed tolerance
- `non-simulatable_exchange_oms_effect`
  - `FUNDING` action exists on one side only (accepted residual)
  - missing live action is supported by a matched `LIVE_ORDER_FAIL_*` event in live audit logs (accepted residual)
- `state_initialisation_gap`
  - replay-only action with reason code `exit_end_of_backtest` (window-boundary force-close)

## Pass Criteria

`status.strict_alignment_pass = true` only when there are no:

- deterministic logic divergences
- numeric policy divergences

Accepted residuals (`FUNDING`, matched `LIVE_ORDER_FAIL_*`, and `exit_end_of_backtest` boundary closes) are retained in `accepted_residuals` for traceability.
