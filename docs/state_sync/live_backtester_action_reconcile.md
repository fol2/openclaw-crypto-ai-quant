# Live vs Backtester Action Reconciliation

## Objective

Validate action-level parity across `live` baseline and replayed `backtester` output for the same bundle window.

Compared canonical actions:

- `OPEN_LONG`, `OPEN_SHORT`
- `ADD_LONG`, `ADD_SHORT`
- `REDUCE_LONG`, `REDUCE_SHORT`
- `CLOSE_LONG`, `CLOSE_SHORT`
- `FUNDING` (classified as accepted residual when one side is missing)

## Inputs

- `live_baseline_trades.jsonl` from replay bundle
- `backtester_replay_report.json` generated by `mei-backtester replay --trades --output ...`

## Command

```bash
python tools/audit_live_backtester_action_reconcile.py \
  --live-baseline /tmp/live_replay_bundle_1h/live_baseline_trades.jsonl \
  --backtester-replay-report /tmp/live_replay_bundle_1h/backtester_replay_report.json \
  --timestamp-bucket-ms 1 \
  --output /tmp/live_replay_bundle_1h/action_reconcile_report.json
```

Use `--timestamp-bucket-ms > 1` only when your live timestamp serialisation is intentionally coarser.

## What Is Checked

- Key match: `symbol + action_code + timestamp_ms`
- Numeric fields: `price`, `size`, `pnl_usd`, `fee_usd`, `balance`
- Confidence parity when both sides provide a confidence value

## Taxonomy

- `deterministic_logic_divergence`
  - missing action on either side
  - confidence mismatch
- `numeric_policy_divergence`
  - matched key exists but numeric deltas exceed tolerance
- `non-simulatable_exchange_oms_effect`
  - `FUNDING` action exists on one side only (accepted residual)

## Pass Criteria

`status.strict_alignment_pass = true` only when there are no:

- deterministic logic divergences
- numeric policy divergences

Funding-only residuals are retained in `accepted_residuals` for traceability.
