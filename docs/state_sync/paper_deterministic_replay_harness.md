# Paper Deterministic Replay Harness

## Objective

Run the full deterministic replay workflow for the paper axis with one command.

The harness executes:

1. snapshot export + paper seed
2. backtester replay
3. state audit
4. live/backtester trade reconcile
5. live/backtester action reconcile
6. live/paper action reconcile
7. live/paper decision-trace reconcile
8. live-baseline vs paper event-order parity
9. bundle-scoped CPU/GPU parity
10. strict alignment gate

## Command

```bash
python tools/run_paper_deterministic_replay.py \
  --bundle-dir /tmp/live_replay_bundle_1h \
  --output /tmp/live_replay_bundle_1h/paper_deterministic_replay_run.json
```

Strict mode (fail if accepted residuals are present):

```bash
python tools/run_paper_deterministic_replay.py \
  --bundle-dir /tmp/live_replay_bundle_1h \
  --strict-no-residuals \
  --output /tmp/live_replay_bundle_1h/paper_deterministic_replay_run.json
```

## Bundle Shortcut

If the replay bundle was generated by `tools/build_live_replay_bundle.py`, run:

```bash
/tmp/live_replay_bundle_1h/run_09_paper_deterministic_replay.sh
```

Strict shortcut:

```bash
STRICT_NO_RESIDUALS=1 /tmp/live_replay_bundle_1h/run_09_paper_deterministic_replay.sh
```

## Standalone Event-Order Audit

```bash
python tools/audit_live_baseline_paper_order_parity.py \
  --live-baseline /tmp/live_replay_bundle_1h/live_baseline_trades.jsonl \
  --paper-db ./trading_engine.db \
  --from-ts 1770700000000 \
  --to-ts 1771200000000 \
  --fail-on-mismatch \
  --output /tmp/live_replay_bundle_1h/event_order_parity_report.json
```

## Output

- report JSON: `paper_deterministic_replay_run.json`
- per-step logs: `<bundle-dir>/harness_logs/*.stdout.log` and `*.stderr.log`

`ok = true` means all steps (including event-order parity and final strict gate) passed.

`gpu_parity` step requires CUDA because it executes GPU sweep lanes inside the bundle scope.
