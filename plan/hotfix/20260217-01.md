# Codebase Security & Code Quality Audit Report (Round 2)

**Project:** OpenClaw AI Quant Trading Engine (Hyperliquid DEX)
**Date:** 2026-02-17
**Status:** OPEN
**Scope:** Full codebase — Python (`engine/`, `strategy/`, `live/`, `exchange/`, `tools/`, `scripts/`) + Rust (`backtester/`) + config/tests/systemd
**Prior audit:** `plan/hotfix/20260216-01.md` (RESOLVED via PR #373 + #374)

---

## Summary

| Severity | Count | Description |
|----------|-------|-------------|
| **HIGH** | 5 | Fix short-term — can cause trade errors or crashes |
| **MEDIUM** | 7 | Mid-term improvements for robustness |
| **LOW** | 6 | Long-term code quality improvements |
| **Total** | **18** | |

---

## HIGH (5)

### H1. `risk.py` — Division by zero in heat calculation

**Location:** `engine/risk.py:442-443`
**Issue:** Heat calculation guards on `heat_usd > 0` but does NOT guard `eq > 0`:
```python
heat_pct = (float(heat_usd) / eq) * 100.0 if heat_usd > 0 else 0.0
```
If equity is zero (e.g. after full liquidation or during initialisation), this produces `ZeroDivisionError` which can crash the risk module.
**Fix:** Add `eq > 0` guard before division. Apply same pattern to all division sites in `risk.py` (lines 213, 246, 356, 442-443).

---

### H2. `executor.py` — TOCTOU race in secrets file permission check

**Location:** `exchange/executor.py:67-81`
**Issue:** `load_live_secrets()` calls `os.stat()` to check permissions, then separately calls `open()` to read. Between the two calls, an attacker with filesystem access can swap the file (time-of-check-time-of-use race).
**Fix:** Open the file first with `os.open()`, then use `os.fstat()` on the file descriptor to check permissions atomically:
```python
fd = os.open(path, os.O_RDONLY)
st = os.fstat(fd)
if (st.st_mode & 0o077) != 0:
    os.close(fd)
    raise ValueError(...)
with os.fdopen(fd, "r", encoding="utf-8") as f:
    data = json.load(f)
```

---

### H3. Bare `except Exception:` silently swallows critical errors

**Locations:**
- `live/trader.py:418-432` — position state recovery catch-all hides DB corruption, OOM, permission errors
- `engine/market_data.py:202-203, 208-209` — DB read failures silently ignored
- `engine/core.py:35-37` — lazy import failure hidden

**Issue:** These catch-all handlers prevent visibility into critical failures. DB corruption or permission errors during live trading will be invisible.
**Fix:** Replace `except Exception:` with specific exception types (`sqlite3.Error`, `OSError`, `ImportError`) and log with `logger.warning(..., exc_info=True)`.

---

### H4. `sidecar.py` — Buffered readline can block indefinitely

**Location:** `exchange/sidecar.py:179`
**Issue:** `self._f.readline()` uses Python's buffered file I/O wrapper over the socket. Even though the underlying socket has a timeout set (line 116), the buffered `readline()` may not respect it — if the sidecar process becomes unresponsive mid-line, the trading loop hangs forever.
**Fix:** Options:
1. Wrap readline in a `select.select()` call with explicit timeout
2. Use `socket.recv()` directly with manual line buffering
3. Use `socket.settimeout()` and catch `socket.timeout` around readline

---

### H5. `rest_client.py` — `json.load(resp)` can block indefinitely

**Location:** `engine/rest_client.py:56-72`
**Issue:** `urlopen()` has a timeout on connection/response headers, but `json.load(resp)` streams the body incrementally and can block indefinitely if the server sends a partial response or stalls mid-body.
**Fix:** Read body first, then parse:
```python
with urllib.request.urlopen(req, timeout=self._timeout_s) as resp:
    raw = resp.read()  # bounded by timeout on socket
data = json.loads(raw)
```

---

## MEDIUM (7)

### M1. `risk.py` — Environment variable parser accepts `inf`/`nan`

**Location:** `engine/risk.py:24-42`
**Issue:** `_env_float()` calls `float()` which accepts `"inf"`, `"-inf"`, `"nan"` as valid inputs. These propagate silently through risk calculations, potentially disabling guardrails (e.g. `max_drawdown = float("inf")` means no drawdown limit).
**Fix:** Add `math.isfinite()` validation after parsing:
```python
v = float(str(raw).strip())
if not math.isfinite(v):
    return float(default)
```

---

### M2. `trader.py` — SQLite connection resource leak

**Location:** `live/trader.py:406-416`
**Issue:** If `db_conn.cursor()` raises but `sqlite3.connect()` succeeded, the connection is never closed. The `finally` block at line 530 only closes the cursor, not the connection.
**Fix:** Use context manager:
```python
with sqlite3.connect(DB_PATH, timeout=_DB_TIMEOUT_S) as db_conn:
    db_cur = db_conn.cursor()
    ...
```
Or ensure `db_conn.close()` is in the finally block alongside cursor close.

---

### M3. `sidecar.py` — UTF-8 decode with `errors="replace"` masks corruption

**Location:** `exchange/sidecar.py:182`
**Issue:** Using `errors="replace"` silently converts invalid bytes to U+FFFD. This can mask transport errors or protocol mismatches in market data, leading to silent data corruption.
**Fix:** Use `errors="strict"` and catch `UnicodeDecodeError` explicitly, logging the raw bytes for debugging.

---

### M4. Systemd services missing resource limits

**Location:** All files in `systemd/*.service.example`
**Issue:** No `MemoryMax`, `CPUQuota`, or `TasksMax` defined. A runaway process (e.g. memory leak, infinite loop) can consume all system resources and take down the host.
**Fix:** Add to all service files:
```ini
MemoryMax=512M
CPUQuota=90%
TasksMax=256
TimeoutStopSec=15
StartLimitBurst=3
StartLimitIntervalSec=60
```
(Tune per-service as needed; live trader may need more memory.)

---

### M5. Pytest coverage scope too narrow

**Location:** `pyproject.toml:40-48`
**Issue:** Coverage is only measured for `engine.sqlite_logger` and `monitor.heartbeat`. Critical modules are not tracked:
- `engine.risk` — risk guardrails
- `exchange.executor` — secrets handling, order execution
- `engine.daemon` — main trading loop
- `live.trader` — live order management
**Fix:** Expand `--cov=` list in pytest addopts to include critical modules.

---

### M6. No SIGTERM handler for graceful shutdown

**Location:** `engine/daemon.py`
**Issue:** Systemd uses `KillMode=process` to stop services. Without a SIGTERM handler, the daemon is killed mid-loop with no opportunity to:
- Drain pending order queue
- Close open positions (if configured)
- Flush log buffers
- Cleanly close DB connections
**Fix:** Register `signal.signal(signal.SIGTERM, handler)` that sets a shutdown flag, then check it in the main loop.

---

### M7. Config example uses aggressive swept defaults

**Location:** `config/strategy_overrides.yaml.example`
**Issue:** `allocation_pct: 0.20` (20% per trade) and `tp_atr_mult: 6.0` are optimised settings from a specific backtest period. An operator copying this verbatim to live without understanding may take excessive risk.
**Fix:** Either:
1. Rename to `strategy_overrides.yaml.swept-example` and create a separate conservative template
2. Add prominent comments at the top warning these are optimised, not conservative defaults

---

## LOW (6)

### L1. `ensemble_runner.py` — Naive string split for daemon command

**Location:** `tools/ensemble_runner.py:248`
**Issue:** Uses `str.split(" ")` instead of `shlex.split()` to parse daemon command. Breaks if paths contain spaces.
**Fix:** `daemon_argv = shlex.split(str(args.daemon_cmd).strip())`

---

### L2. `risk.py` — Magic numbers without named constants

**Location:** `engine/risk.py` — multiple lines (102, 247, 1779)
**Issue:** Hardcoded values like `1000.0`, `1e-9`, unnamed thresholds reduce readability.
**Fix:** Define module-level constants:
```python
MAX_ENTRY_RATE_ORDERS = 1000
EPSILON_USD = 1e-9
```

---

### L3. Excessive `suppress(Exception)` usage

**Location:** `engine/sqlite_logger.py:92-94, 130-134, 180-189`
**Issue:** `suppress(Exception)` is too broad. Should use `suppress(sqlite3.Error, OSError)` to only catch expected failure modes.

---

### L4. Missing type hints on public APIs

**Locations:**
- `strategy/mei_alpha_v1.py:75-134` — `build_indicator_snapshot()` lacks return type
- `engine/core.py` — several entry points missing type hints
**Fix:** Add type hints to public API boundaries for IDE support and static analysis.

---

### L5. Rust: `RingBuf` missing `is_empty()` method

**Location:** `backtester/crates/bt-core/src/indicators/mod.rs:43`
**Issue:** Has `len()` but no `is_empty()`. Clippy flags this as inconsistent with standard Rust collections.
**Fix:** Add `pub fn is_empty(&self) -> bool { self.len() == 0 }`

---

### L6. Rust: Functions with 8+ parameters

**Locations:**
- `backtester/crates/bt-core/src/engine.rs:620` (8 args), `:734` (10 args), `:2292` (11 args)
- `backtester/crates/bt-core/src/decision_kernel.rs:572` (11 args)
- `backtester/crates/bt-core/src/kernel_exits.rs:209` (8 args)
- `backtester/crates/bt-core/src/report.rs:156` (9 args)
**Issue:** High arity reduces readability and makes testing harder.
**Fix:** Group related parameters into structs (e.g. `TradeContext`, `ExitParams`).

---

## Positive Findings (no action needed)

| Area | Status |
|------|--------|
| `secrets.json` permission enforcement (`executor.py:78-80`) | Good |
| `.gitignore` excludes secrets, DB, env files | Good |
| All Python dependencies pinned to exact versions | Good |
| Atomic config writes in `promote_to_live.py` | Good |
| Monitor path traversal protection (`server.py:2573-2576`) | Good |
| Deployment validation gates (paper test, funding, kill-event) | Good |
| **Rust: No memory safety issues — all unsafe blocks justified** | Good |
| **Rust: Checked arithmetic for VRAM allocation** | Good |
| **Rust: All division sites properly guarded** | Good |
| **Rust: NaN/Inf handling + 309 unit tests passing** | Good |
| **Rust: GPU precision tolerance tiers (T0-T4) well-designed** | Good |
| **Rust: No panics in production paths — unwraps only in tests** | Good |

---

## Recommended Fix Priority

**Immediate (HIGH — do first):**
1. H1 — `risk.py` division-by-zero guards
2. H3 — Replace bare `except Exception:` in critical paths
3. H5 — `rest_client.py` read body before JSON parse
4. H4 — `sidecar.py` readline timeout
5. H2 — `executor.py` TOCTOU fix

**Short-term (MEDIUM — next sprint):**
6. M1 — `_env_float()` validate `isfinite()`
7. M2 — Fix DB connection leak
8. M6 — SIGTERM graceful shutdown handler
9. M4 — Systemd resource limits
10. M5 — Expand pytest coverage scope

**Backlog (LOW):**
11-18. L1–L6, M3, M7
