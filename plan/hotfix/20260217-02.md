# Codebase Security & Code Quality Audit Report (Round 3)

**Project:** OpenClaw AI Quant Trading Engine (Hyperliquid DEX)
**Date:** 2026-02-17
**Status:** OPEN — 14 issues to resolve
**Scope:** Full codebase — Python (`engine/`, `strategy/`, `live/`, `exchange/`, `tools/`) + Rust (`backtester/`) + config/systemd/monitor
**Prior audits:** `plan/hotfix/20260216-01.md` (RESOLVED), `plan/hotfix/20260217-01.md` (PARTIAL)

---

## Summary

| Severity | Count | Description |
|----------|-------|-------------|
| **CRITICAL** | 4 | Must fix immediately — can cause crashes, data corruption, or security issues |
| **HIGH** | 6 | Fix short-term — can cause trade errors, silent failures, or info leaks |
| **MEDIUM** | 4 | Mid-term improvements for robustness and observability |
| **Total** | **14** | |

---

## CRITICAL (4)

### C1. SQL Injection — Dynamic Column/Placeholder Construction

**Locations:**
- `engine/oms.py:509` — `f"UPDATE oms_intents SET {', '.join(sets)} WHERE intent_id = ?"`
- `live/trader.py:664` — `f"DELETE FROM position_state WHERE symbol NOT IN ({placeholders})"`
- `tools/flat_now.py:138-147` — dynamic column names in INSERT via f-string

**Issue:** While column values are validated (allowlist in OMS, sanitised in flat_now), constructing SQL via f-strings is an anti-pattern. If validation is ever bypassed or a new code path is introduced, injection is possible.
**Fix:** For OMS UPDATE — pre-define allowed column→placeholder mappings, build query from validated set only. For DELETE WHERE IN — use a temp table or batch parameterised queries. For flat_now — use explicit column list constant, not dynamic construction.

---

### C2. GPU Code `.expect()` Panics on Recoverable Errors

**Locations:**
- `backtester/crates/bt-gpu/src/lib.rs:163-165` — `num_bars` overflow `.expect()` panics
- `backtester/crates/bt-gpu/src/lib.rs:201-203` — GPU memory upload `.expect()` panics
- `backtester/crates/bt-gpu/src/lib.rs:260-269` — VRAM budget `.expect()` panics

**Issue:** GPU memory failures and integer overflow are runtime events. Using `.expect()` crashes the entire sweep instead of skipping the combo gracefully.
**Fix:** Replace all `.expect()` with `?` operator, propagating errors as `Result`. Caller should log error and skip the failing combo.

---

### C3. Atomic Write Race Condition in `promote_to_live.py`

**Location:** `tools/promote_to_live.py:62-67`
**Issue:** `_atomic_write_text()` uses `os.getpid()` as temp file suffix. If two processes run concurrently with PID reuse, the live trading config YAML can be corrupted mid-write.
**Fix:** Use `tempfile.NamedTemporaryFile(dir=parent, delete=False)` or append UUID to temp filename:
```python
import uuid
tmp = path.with_name(f".{path.name}.tmp.{uuid.uuid4().hex[:12]}")
```

---

### C4. Interactive `input()` in Emergency/Deployment Tools

**Locations:**
- `tools/flat_now.py:321` — `input("Proceed? [y/N]")` in emergency flatten helper
- `tools/deploy_sweep.py:342` — `input("Apply these changes? [y/N]")` in deployment tool

**Issue:** If run in automated contexts (cron, systemd timer, CI), `input()` hangs indefinitely. For emergency flatten, this blocks incident response.
**Fix:** Add `--yes` / `--no-confirm` CLI flag. Check `sys.stdin.isatty()` — if not a TTY and `--yes` not passed, abort with clear error message.

---

## HIGH (6)

### H1. Division by Zero — Multiple Locations

**Locations:**
- `backtester/crates/bt-core/src/engine.rs:1610` — `compute_market_breadth()`: `bullish / total` with no guard when `total == 0`
- `backtester/crates/bt-core/src/engine.rs:1623` — `compute_ema_slow_slope()`: divides by `current_close` with no guard
- `backtester/crates/risk-core/src/lib.rs:60` — `adx / adx_sizing_full_adx` with no guard
- `live/trader.py:720` — `abs(sz) * float(px) / lev` if `lev == 0`
- `live/trader.py:1050` — `baseline_vol / float(current_atr)` if `current_atr == 0`

**Fix:** Add `> 0` guards before every division. Return `0.0` or safe default when denominator is zero or non-finite.

---

### H2. Silent Error Swallowing in Trading Critical Path

**Locations:**
- `exchange/executor.py:407-412` — `_slippage_price()` exception caught as `None`, no logging
- `live/trader.py:1169-1189` — OMS intent creation `except Exception` with no log of actual error
- `live/trader.py:1310-1325` — `except TypeError` to handle API signature changes (fragile)

**Fix:** Add `logger.debug("...", exc_info=True)` in all silent catch blocks. Replace `except TypeError` with explicit version check or duck-typing.

---

### H3. Database Connection Resource Leak

**Locations:**
- `live/trader.py:409-521` — cursor goes stale after exception but no re-connect
- `engine/oms.py` — most methods have `try/finally conn.close()` but pattern is inconsistent

**Fix:** Use context manager pattern consistently:
```python
with sqlite3.connect(DB_PATH, timeout=timeout_s) as conn:
    cur = conn.cursor()
    ...
```

---

### H4. Race Condition — `_pending_open_sent_at_s` Dictionary

**Location:** `live/trader.py:295-300`
**Issue:** `threading.Lock()` exists but not all access paths to `_pending_open_sent_at_s` use it consistently. Dictionary mutation from multiple threads without locking can cause `RuntimeError: dictionary changed size during iteration`.
**Fix:** Audit all access sites; wrap every read/write in `with self._pending_open_lock:`.

---

### H5. Monitor Server — No Authentication

**Location:** `monitor/server.py:2793-2796`
**Issue:** If `AIQ_MONITOR_BIND=0.0.0.0`, all trading decisions, positions, and replay endpoints are exposed without auth. No rate limiting either.
**Fix:**
1. Add `AIQ_MONITOR_TOKEN` env var; validate `Authorization: Bearer <token>` on all `/api/` endpoints
2. Add simple token-bucket rate limiter per client IP
3. Log warning if bind is not `127.0.0.1`

---

### H6. Database `chmod` Silent Failure

**Locations:**
- `exchange/ws.py:85` — `os.chmod(DB_PATH, 0o600)` in `try/except: pass`
- `engine/sqlite_logger.py:137` — same pattern

**Fix:** Replace silent `pass` with `logger.warning("Failed to set DB permissions: %s", exc)`. Consider fail-closed for sensitive DBs (live trading DB).

---

## MEDIUM (4)

### M1. Bare `except Exception:` Throughout Codebase

**Locations:**
- `engine/strategy_manager.py:161, 198, 264`
- `engine/daemon.py:81, 113, 144`
- `tools/check_funding_rates_db.py:490`
- `tools/factory_cycle.py:704, 1577`

**Issue:** Catches `KeyboardInterrupt`, `SystemExit`, `MemoryError`. Masks critical failures.
**Fix:** Replace with specific exceptions (`sqlite3.Error`, `OSError`, `ValueError`, `ImportError`). At minimum, re-raise `SystemExit` and `KeyboardInterrupt`.

---

### M2. Factory Run DB Read Without Read-Only Mode

**Location:** `factory_run.py:152`
**Issue:** `sqlite3.connect(str(db_path), timeout=10)` opens live DB in read-write mode when only reading balance.
**Fix:** Use URI mode: `sqlite3.connect(f"file:{db_path}?mode=ro", uri=True, timeout=10)`

---

### M3. Missing `/health` Endpoint in Monitor

**Location:** `monitor/server.py`
**Issue:** No simple health check endpoint for systemd `Type=notify` or external monitoring.
**Fix:** Add `GET /health` → `{"status": "ok", "uptime_s": N}` with no auth required.

---

### M4. WS Sidecar Socket Path Fallback to `/tmp`

**Location:** `ws_sidecar/src/main.rs:115`
**Issue:** If `XDG_RUNTIME_DIR` is not set, socket falls back to `/tmp/openclaw-ai-quant-ws.sock` which is world-writable. Any local user could create the socket first (MITM on market data).
**Fix:** Fail-closed: if `XDG_RUNTIME_DIR` is not set, log error and exit instead of falling back to `/tmp`.

---

## Positive Findings (no action needed)

| Area | Status |
|------|--------|
| SQLite parameterised queries (vast majority of code) | Good |
| `yaml.safe_load()` everywhere, no `yaml.load()` | Good |
| `subprocess.run()` with list args, no `shell=True` | Good |
| Secrets file permission check via `os.open()` + `fstat()` | Good |
| WAL mode + `PRAGMA synchronous=NORMAL` on all DBs | Good |
| Error message redaction for secrets (`daemon.py`) | Good |
| `.gitignore` excludes secrets, DB, env, key files | Good |
| Rust core engine — zero `unsafe` blocks | Good |
| Rust: deterministic symbol ordering (sorted HashMap keys) | Good |
| Rust: GPU precision tolerance tiers (T0–T4) well-designed | Good |
| Rust: checked arithmetic for VRAM allocation | Good |
| Rust: 309 unit tests passing | Good |

---

## Recommended Fix Order

**Batch 1 — Immediate (CRITICAL):**
1. C1 — SQL dynamic construction → safe patterns
2. C2 — GPU `.expect()` → `?` operator
3. C3 — Atomic write UUID temp file
4. C4 — `--yes` flag for emergency/deploy tools

**Batch 2 — High (this sprint):**
5. H1 — Division-by-zero guards (Rust + Python)
6. H2 — Silent error swallowing → add logging
7. H3 — DB connection resource leak → context managers
8. H4 — Pending open dict race condition → consistent locking
9. H5 — Monitor auth + rate limiting
10. H6 — DB chmod silent failure → log warning

**Batch 3 — Medium (next sprint):**
11. M1 — Bare `except Exception:` → specific types
12. M2 — Factory run read-only DB
13. M3 — Monitor `/health` endpoint
14. M4 — WS sidecar socket path fail-closed
