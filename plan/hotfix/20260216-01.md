# Codebase Security & Code Quality Audit Report

**Project:** OpenClaw AI Quant Trading Engine (Hyperliquid DEX)
**Date:** 2026-02-16
**Status:** RESOLVED — PR #373 (Python) + PR #374 (Rust) merged to master
**Scope:** Full codebase — Python (`engine/`, `strategy/`, `live/`, `exchange/`, `tools/`, `scripts/`) + Rust (`backtester/`) + config/tests/systemd

---

## Summary

| Severity | Count | Description |
|----------|-------|-------------|
| **CRITICAL** | 6 | Immediate action required — real money at risk |
| **HIGH** | 12 | Fix short-term — can cause trade errors or crashes |
| **MEDIUM** | 14 | Mid-term improvements for robustness |
| **LOW** | 10 | Long-term optimizations |
| **Total** | **42** | (deduplicated across 5 parallel review agents) |

---

## CRITICAL (6)

### C1. `secrets.json` stored in repo root

**Location:** `/secrets.json`
**Issue:** The file containing the Hyperliquid signing private key and wallet address sits in the project root. While `.gitignore` excludes it, the file is exposed if the directory is copied, backed up, or the system is compromised. Additionally, `factory_run.py:179` contains a hardcoded absolute path to this file.
**Fix:**
- Move to `~/.config/openclaw/ai-quant-secrets.json`
- Remove hardcoded path from `factory_run.py:179`
- Verify never committed: `git log --all -- secrets.json`
- Consider key rotation

### C2. Risk guardrail exception falls through — orders still submitted

**Location:** `live/trader.py:1162-1201, 2413-2455`
**Issue:** When `risk.allow_order()` raises an exception, `except Exception: pass` allows the order to proceed. This defeats the entire risk guardrail if there is a bug in risk calculation.
**Fix:**
```python
except Exception:
    logger.error("risk.allow_order() raised, BLOCKING order as fail-closed")
    return False
```

### C3. Bare `except Exception` silently swallows errors across codebase

**Locations:**
- `live/trader.py:378-380, 569-570, 593-594, 629-630`
- `engine/core.py:446`
- `engine/market_data.py:491-498`
- `engine/oms.py:1174-1177`
- `exchange/ws.py:582-585`
- `strategy/kernel_orchestrator.py:666-668`

**Issue:** Dozens of bare `except Exception` clauses with no logging. DB connection failures, JSON parse errors, and other critical errors are silently swallowed, making production debugging impossible.
**Fix:** Replace each with specific exception type + `logger.warning()`/`logger.error()`.

### C4. DB connection resource leaks — no context managers

**Locations:**
- `live/trader.py:376-380, 2091-2103, 3267-3285`
- `engine/market_data.py:648-673`

**Issue:** DB connections use try/finally pattern that can leak on exception paths. Should use `with sqlite3.connect(...) as conn:` context managers.
**Fix:** Refactor all `sqlite3.connect()` calls to use `with` statements.

### C5. Rust backtester: ATR division-by-zero unprotected

**Locations:**
- `backtester/crates/bt-core/src/kernel_exits.rs:163-165, 573`
- `backtester/crates/bt-core/src/exits/smart_exits.rs:222`

**Issue:** `compute_sl_price()` and smart exit code divide by ATR without zero-check. If candle data has gaps, ATR=0 produces NaN/Inf that propagates to exit prices.
**Fix:** Add `let atr = atr.max(1e-12);` before division.

### C6. Rust GPU: `panic!` on CUDA init failure, no CPU fallback

**Location:** `backtester/crates/bt-gpu/src/gpu_host.rs:58-63`
**Issue:** CUDA initialization failure calls `panic!()`, crashing the entire backtester with no graceful degradation to CPU mode.
**Fix:** Return `Result<>` and let caller fall back to CPU sweep.

---

## HIGH (12)

### H1. Exchange timeout creates order state divergence

**Location:** `live/trader.py:1287-1319`
**Issue:** On order submission timeout, code assumes failure, but order may have executed on exchange. Trader state diverges from actual exchange state.
**Fix:** After timeout, trigger reconciliation check before next cycle.

### H2. `_pending_open_sent_at_s` dict has no thread lock

**Location:** `live/trader.py:488-492, 2599-2603, 2744-2747`
**Issue:** Multiple threads (order submission, exchange sync, fill callback) race on this dict, potentially exceeding `max_open_positions`.
**Fix:** Protect with `threading.Lock`.

### H3. Exchange fill responses lack validation

**Location:** `live/trader.py:2816-2865`
**Issue:** Unknown fill direction silently skipped without logging. No validation that `sz > 0` or `px > 0` after parsing.
**Fix:** Add validation + warning log for unexpected fill data.

### H4. Database files world-readable (644 permissions)

**Location:** All `*.db` files in project root
**Issue:** Trading DBs contain balances, positions, and strategy parameters but are readable by any local user.
**Fix:** Add `os.chmod(db_path, 0o600)` during DB creation in `sqlite_logger.py` and `oms.py`.

### H5. Sidecar RPC uses `assert` as precondition check

**Location:** `exchange/sidecar.py:167`
**Issue:** `assert self._f is not None` in production code — disabled if Python runs with `-O` flag.
**Fix:** Replace with `if self._f is None: raise RuntimeError("sidecar connection broken")`.

### H6. Sidecar socket error has no logging

**Location:** `exchange/sidecar.py:180-183`
**Issue:** Socket connection errors re-raise but with no log context. Production cannot diagnose sidecar disconnect causes.
**Fix:** Add `logger.error(f"sidecar RPC failed: method={method} error={e}")` before raise.

### H7. Indicator data has no NaN/Inf validation

**Locations:**
- `engine/market_data.py:681-695`
- `backtester/crates/bt-core/src/indicators/atr.rs`

**Issue:** Float values from candle DBs pass through without `math.isfinite()` checks. NaN/Inf propagates silently into strategy calculations.
**Fix:** Add finite check on all candle numeric fields; replace non-finite with `None`.

### H8. Live safety gates have no test coverage

**Location:** `exchange/executor.py:491-505`
**Issue:** `live_orders_enabled()` involves kill switch, enable flag, and confirmation string but has no dedicated test file.
**Fix:** Create `tests/test_live_safety_gates.py` covering all combinations.

### H9. Rust engine `.expect()` in simulation logic

**Locations:** `bt-core/src/engine.rs:2901, 2921, 3138, 3206, 3420, 3447, 3469`
**Issue:** Position and gate lookups use `.expect()` which panics the entire backtest on unexpected state.
**Fix:** Replace with `?` operator and proper error propagation.

### H10. Rust `add_to_position` near-zero division

**Location:** `bt-core/src/position.rs:116-119`
**Issue:** Floating-point rounding can make `total_size` near-zero while passing `> 0.0` check, producing extreme entry_price.
**Fix:** Add `if total_size < 1e-12 { self.entry_price = add_price; return; }`.

### H11. GPU memory allocation unwrap

**Location:** `bt-gpu/src/gpu_host.rs:136, 145-153`
**Issue:** GPU OOM conditions trigger panic via `.unwrap()`.
**Fix:** Use `?` or `.map_err()` to return error to caller.

### H12. Reconciliation critical mismatch has no kill-switch

**Location:** `live/reconciler.py:264-301`
**Issue:** Side mismatch (kernel thinks LONG, exchange is SHORT) is logged as `severity=critical` but trading continues. No automatic alert or emergency stop.
**Fix:** Trigger kill-switch or mandatory alert on critical severity.

---

## MEDIUM (14)

### M1. Subprocess args not whitelist-validated

**Location:** `engine/openclaw_cli.py:85-95`
**Issue:** `channel`, `target`, `message` params passed to subprocess without validation.
**Fix:** Validate against whitelist of known channels/targets.

### M2. Env var numeric values have no upper bound

**Location:** `live/trader.py:24-26, 312-315`
**Issue:** `AI_QUANT_LIVE_MAX_NOTIONAL_USD_PER_ORDER` can be set to arbitrary values with no bounds check.
**Fix:** Add `max()` / `min()` clamping with reasonable bounds.

### M3. WS event queues: 4 x 5000 = 20K items, no memory alert

**Location:** `exchange/ws.py:697-744`
**Issue:** Four separate event queues with 5000-item limits. Queue eviction is silent — no metric or log when messages are dropped.
**Fix:** Log when queue limits are hit.

### M4. WS JSON parse error silently returns

**Location:** `exchange/ws.py:582-585`
**Issue:** `except Exception: return` drops malformed WS messages without logging.
**Fix:** Catch `json.JSONDecodeError` specifically and log a warning.

### M5. WS health() dict iteration race with reconnect thread

**Location:** `exchange/ws.py:372-389`
**Issue:** Dict iteration during health check can race with WS reconnect modifying the dict.
**Fix:** Copy dict under lock before iterating.

### M6. Metadata refresh failure not logged

**Location:** `exchange/meta.py:52-56`
**Issue:** Hyperliquid API failure in metadata refresh is silently caught.
**Fix:** Add `logger.warning(f"metadata refresh failed: {e}")`.

### M7. SQL column names via f-string in flat_now.py

**Location:** `tools/flat_now.py:137`
**Issue:** Dynamic column list via f-string — fragile if validation removed in future refactor.
**Fix:** Use explicit quoted column names with whitelist.

### M8. Hardcoded absolute path in factory_run.py

**Location:** `factory_run.py:179`
**Issue:** `/home/fol2hk/openclaw-plugins/ai_quant/secrets.json` hardcoded.
**Fix:** Use `AIQ_ROOT / "secrets.json"` or env var only.

### M9. Secret key may appear in traceback

**Location:** `engine/daemon.py:956-958`
**Issue:** If executor init fails, traceback may include `secret_key` parameter.
**Fix:** Catch and re-raise without sensitive data: `raise RuntimeError("Executor init failed") from None`.

### M10. Risk rate-limit params have no upper bound

**Location:** `engine/risk.py:101-148`
**Issue:** `AI_QUANT_RISK_MAX_ENTRY_ORDERS_PER_MIN` has `max(1.0, ...)` but no ceiling.
**Fix:** Add `min(1000.0, ...)` upper bound.

### M11. Alert queue drops messages silently

**Location:** `engine/alerting.py:171-173`
**Issue:** When alert queue is full, `put_nowait()` silently drops. No metric exposed.
**Fix:** Track and log dropped alert count.

### M12. GPU f32 vs CPU f64 precision divergence

**Location:** `bt-gpu/src/buffers.rs`
**Issue:** GPU uses f32, CPU uses f64. Indicator parity tests may have thresholds too loose for precision loss.
**Fix:** Verify parity test tolerance is appropriate (~1e-7 for f32).

### M13. Rust margin_used division-by-zero

**Location:** `bt-core/src/engine.rs:1149, 2319`
**Issue:** `margin_headroom / margin_used` without zero-check.
**Fix:** Guard with `if margin_used > 1e-12`.

### M14. Systemd services lack sandboxing

**Location:** `systemd/*.service.example`
**Issue:** No `ProtectHome=`, `ProtectSystem=`, `NoNewPrivileges=`, or `PrivateTmp=` directives.
**Fix:** Add systemd hardening directives.

---

## LOW (10)

| # | Issue | Location |
|---|-------|----------|
| L1 | Magic numbers throughout (`0.005`, `1e-12`, `30`) | Multiple files |
| L2 | Missing type hints on critical functions | `trader.py`, `core.py` |
| L3 | String literals instead of enums (`"BUY"`, `"OPEN"`) | Entire codebase |
| L4 | Discord worker uses global queue — multi-instance conflict | `trader.py:120-129` |
| L5 | Test coverage only enforced on `sqlite_logger` | `pyproject.toml` |
| L6 | Env var documentation incomplete | `.env.example` |
| L7 | Event logger JSON failure silently returns | `engine/event_logger.py:130-133` |
| L8 | Rust dead code `#[allow(dead_code)] mod precompute` | `bt-gpu/src/lib.rs:6` |
| L9 | Rust CLI no validation on `initial_balance > 0` | `bt-cli/src/main.rs:204` |
| L10 | SSL verification not explicitly configured | `exchange/executor.py` |

---

## Positive Findings

The codebase demonstrates several strong practices:
- Parameterized SQL queries in most locations
- No `eval()` / `exec()` usage
- Kill switch design (hard + soft) is well-architected
- Slippage detection has defense-in-depth
- OMS dedupe key prevents duplicate orders
- Secrets file permission check exists (`executor.py:76`)
- Bounded queue limits for event buffering
- Rust accounting uses `quantize()` with 12-digit precision
- Good use of type hints in newer code

---

## Remediation Plan

### Phase 1 — Immediate (This Week)

| Priority | Item | Effort |
|----------|------|--------|
| P0 | C2: Risk guardrail fail-closed | 30 min |
| P0 | C1: Move `secrets.json` out of repo | 1 hr |
| P0 | H4: DB file permissions → 600 | 30 min |
| P0 | C5: ATR zero-guard (Python + Rust) | 1 hr |
| P0 | H8: Live safety gates test | 1 hr |
| P0 | H12: Reconciliation critical → kill-switch | 1 hr |

### Phase 2 — Short-term (1-2 Weeks)

| Priority | Item | Effort |
|----------|------|--------|
| P1 | C4: All DB connections → context managers | 2 hr |
| P1 | C3: Bare except → specific exception + log | 3 hr |
| P1 | H1: Timeout → reconciliation check | 2 hr |
| P1 | H2: Thread lock for pending open dict | 1 hr |
| P1 | H5/H6: Sidecar assert + error logging | 1 hr |
| P1 | H7: NaN/Inf validation on indicators | 2 hr |
| P1 | M9: Secret key traceback redaction | 30 min |

### Phase 3 — Mid-term (Sprint)

| Priority | Item | Effort |
|----------|------|--------|
| P2 | C6: GPU graceful fallback | 2 hr |
| P2 | H9/H10/H11: Rust `.expect()` → error propagation | 3 hr |
| P2 | M2/M10: Env var bounds validation | 1 hr |
| P2 | M3/M4: WS queue + JSON error logging | 1 hr |
| P2 | L5: Expand test coverage to all engine modules | 4 hr |
| P2 | M14: Systemd sandboxing | 1 hr |
